<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¿¡ç”¨å¡å›é¥‹æŸ¥è©¢åŠ©æ‰‹ 2026</title>
    <style>
        /* === åŸºç¤é‡ç½® === */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --color-primary: #2180a0;
            --color-bg: #f4f7f6;
            --color-surface: #ffffff;
            --color-text: #333333;
            --color-subtext: #666666;
            --color-border: #e0e0e0;
            --color-success: #2e7d32;
            
            /* === å“ç‰Œè‰²å®šç¾© === */
            --brand-richart: #e01a22;
            --brand-cube: #00AA4F;
            --brand-unicard: #1890ff;
            --brand-ubear: #e6b800;
            --brand-dawho: #2d3436;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 16px;
            padding-bottom: 100px; /* é¿é–‹åº•éƒ¨å°è¦½åˆ— */
            line-height: 1.5;
            font-size: 16px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        h1 { 
            text-align: center; margin-bottom: 15px; 
            color: var(--color-primary); font-size: 1.5rem; font-weight: 800; 
        }

        /* === å°è¦½åˆ— === */
        .nav-tabs {
            display: flex; background: var(--color-surface); padding: 4px;
            border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 20px; position: sticky; top: 10px; z-index: 900;
        }
        .nav-item {
            flex: 1; text-align: center; padding: 10px; cursor: pointer;
            border-radius: 8px; font-weight: 600; color: #999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 0.9rem; gap: 2px; transition: all 0.2s;
        }
        .nav-icon { font-size: 1.2rem; display: none; }
        .nav-item.active { background-color: #e3f2fd; color: var(--color-primary); }

        /* æ‰‹æ©Ÿç‰ˆå°è¦½åˆ—å›ºå®šåº•éƒ¨ */
        @media (max-width: 768px) {
            .nav-tabs {
                position: fixed; bottom: 0; top: auto; left: 0; right: 0;
                margin-bottom: 0; border-radius: 0; 
                padding: 6px 0;
                padding-bottom: env(safe-area-inset-bottom);
                background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(10px);
                border-top: 1px solid #eee; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            }
            .nav-item { background: transparent !important; color: #bbb; padding: 6px; font-size: 0.75rem; }
            .nav-item.active { color: var(--color-primary); }
            .nav-icon { display: block; font-size: 1.4rem; margin-bottom: 2px; }
            body { padding-top: 10px; padding-bottom: 90px; }
        }

        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === è¡¨å–®å€å¡Š === */
        .form-section {
            background: var(--color-surface); padding: 16px;
            border-radius: 16px; margin-bottom: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #eee;
        }
        .info-text {
            background: #e3f2fd; padding: 10px 14px; border-radius: 8px; color: #0d47a1;
            margin-bottom: 15px; font-size: 0.85rem; border-left: 4px solid #2196f3;
        }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 6px; font-weight: 700; color: #444; font-size: 0.9rem; }
        
        .input-wrapper { position: relative; display: flex; align-items: center; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px 34px 12px 14px; 
            border: 1px solid var(--color-border); border-radius: 10px;
            font-size: 16px; background: #fff; appearance: none; color: #333;
        }
        input:focus, select:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(33, 128, 160, 0.1); }
        
        .clear-btn {
            position: absolute; right: 8px; background: #eee; border: none; border-radius: 50%;
            width: 24px; height: 24px; cursor: pointer; color: #888; 
            display: none; align-items: center; justify-content: center; font-size: 12px;
        }

        .suggestion-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; background: #fff;
            border: 1px solid #eee; border-radius: 0 0 10px 10px;
            max-height: 250px; overflow-y: auto; z-index: 1000; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none;
        }
        .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f9f9f9; font-size: 0.95rem; }
        .suggestion-item:active { background: #f0f0f0; }

        .controls-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .control-group { flex: 1; }
        .toggle-btn {
            display: flex; align-items: center; justify-content: center; padding: 0 12px;
            background: #fff; border: 1px solid var(--color-border); border-radius: 10px;
            cursor: pointer; user-select: none; font-size: 0.85rem; height: 46px; 
            white-space: nowrap; transition: all 0.2s; color: #555;
        }
        .toggle-btn.active { 
            background: #e3f2fd; border-color: var(--color-primary); 
            color: var(--color-primary); font-weight: 700; 
        }
        .toggle-checkbox { margin-right: 6px; width: 16px; height: 16px; pointer-events: none; }

        .category-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .category-tag {
            padding: 5px 12px; background: #fff; border: 1px solid #ddd; border-radius: 20px;
            cursor: pointer; font-size: 0.85rem; color: #555; user-select: none;
        }
        .category-tag.active { background: var(--color-primary); color: #fff; border-color: var(--color-primary); }

        /* === æœå°‹åˆ—è¡¨ (Compact Mode) === */
        .merchant-list {
            background: #fff; padding: 12px 14px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;
            border: 1px solid #eee; border-left: 4px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
        }
        .merchant-list:active { background-color: #fafafa; transform: scale(0.99); }

        /* å“ç‰Œè‰²æ¡†ç·š */
        .card-theme-richart { border-left-color: var(--brand-richart) !important; }
        .card-theme-cube { border-left-color: var(--brand-cube) !important; }
        .card-theme-unicard { border-left-color: var(--brand-unicard) !important; }
        .card-theme-ubear { border-left-color: var(--brand-ubear) !important; }
        .card-theme-dawho { border-left-color: var(--brand-dawho) !important; }

        /* åˆ—è¡¨å·¦å´ */
        .merchant-info { display: flex; flex-direction: column; }
        .merchant-name { font-size: 1rem; font-weight: 700; color: #333; line-height: 1.2; margin-bottom: 3px; }
        .merchant-type { 
            font-size: 0.75rem; color: #888; background: #f0f0f0; 
            padding: 2px 6px; border-radius: 4px; align-self: flex-start; 
        }

        /* åˆ—è¡¨å³å´ (å›é¥‹ç‡ & å¡ç‰‡) */
        .merchant-best-info { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .best-rate { 
            color: var(--color-primary); font-weight: 800; font-size: 1.3rem; 
            line-height: 1; margin-bottom: 4px; 
        }
        .best-card-row { 
            display: flex; align-items: center; justify-content: flex-end; 
            font-size: 0.85rem; color: #666; gap: 4px; flex-wrap: wrap; 
        }
        
        .card-icon-shape { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* æ–¹æ¡ˆæ¨™ç±¤ (çµ±ä¸€æ·ºè—è‰²) */
        .scheme-badge {
            display: inline-block; vertical-align: middle;
            background-color: #e3f2fd; color: var(--color-primary); 
            border: 1px solid #bbdefb;
            padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 600;
            white-space: nowrap;
        }
        .list-badge { margin-left: 6px; }
        .scheme-badge.new-user { background-color: #fff3e0; color: #e65100; border-color: #ffe0b2; }

        /* === Accordion (æ¬Šç›Šç¸½è¦½) === */
        .card-accordion-item {
            background: #fff; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; border-left: 4px solid #ccc;
            overflow: hidden;
        }
        .accordion-header {
            padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            background: #fff;
        }
        .card-title-text { font-weight: 700; font-size: 1rem; color: #333; margin-left: 8px; }
        .accordion-body { display: none; padding: 0; background: #fafafa; border-top: 1px solid #eee; }
        .accordion-body.open { display: block; }
        
        .benefit-row { padding: 10px 16px; border-bottom: 1px solid #eee; }
        .benefit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .benefit-name { font-weight: 600; font-size: 0.9rem; color: #444; }
        .benefit-rate { font-weight: 700; color: var(--color-primary); font-size: 1rem; }
        .benefit-desc { font-size: 0.8rem; color: #666; line-height: 1.4; }
        .benefit-note { 
            margin-top: 4px; font-size: 0.75rem; color: #856404; 
            background: #fff8e1; padding: 3px 8px; border-radius: 6px; display: inline-block; 
        }

        /* === è©¦ç®—çµæœæ¨£å¼ (å¼·åˆ¶é å³) === */
        .calc-result-item { 
            margin-bottom: 10px; padding: 14px; background: white; 
            border: 1px solid #eee; border-radius: 12px; border-left: 4px solid #ccc;
        }
        .calc-result-item.winner { 
            background: #ffffff; box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            border: 1px solid rgba(0,0,0,0.05); 
        }
        
        .calc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .calc-title { font-weight: 700; font-size: 1rem; color: #333; line-height: 1.3; }
        
        /* é‡‘é¡é å³è¨­å®š */
        .calc-money { 
            font-size: 1.4rem; font-weight: 800; color: #333; 
            white-space: nowrap; flex-shrink: 0; margin-left: 10px; text-align: right; 
        }
        
        /* å† è»é¡¯ç¤ºå“ç‰Œè‰² */
        .calc-result-item.winner.card-theme-richart .calc-money { color: var(--brand-richart); }
        .calc-result-item.winner.card-theme-cube .calc-money { color: var(--brand-cube); }
        .calc-result-item.winner.card-theme-unicard .calc-money { color: var(--brand-unicard); }
        .calc-result-item.winner.card-theme-ubear .calc-money { color: #b8860b; } 
        .calc-result-item.winner.card-theme-dawho .calc-money { color: var(--brand-dawho); }

        .calc-detail { font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.03); padding: 6px 10px; border-radius: 6px; margin-top: 6px; font-family: monospace; }

        /* æ‹†å–®å»ºè­° */
        .split-box {
            margin-top: 10px; padding: 10px; background: #f1f8e9;
            border: 1px dashed #aed581; border-radius: 8px; color: #33691e; font-size: 0.85rem;
        }
        .split-title { font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; }
        .split-step { padding-left: 10px; position: relative; margin-bottom: 2px; }
        .split-step::before { content: 'â€¢'; position: absolute; left: 0; }

        /* === å½ˆçª— (Bottom Sheet Style) === */
        .detail-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2000; 
            justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(2px);
        }
        .detail-modal.show { display: flex; }
        .detail-content {
            background: #fff; border-radius: 16px; width: 100%; max-width: 450px;
            max-height: 80vh; display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s;
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .detail-header { padding: 12px 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .detail-title h2 { font-size: 1.1rem; color: var(--color-primary); margin: 0; }
        .detail-close { background: #f5f5f5; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; cursor: pointer; color: #666; }
        .detail-body { padding: 16px; overflow-y: auto; }
        
        .detail-card-item { 
            margin-bottom: 10px; border: 1px solid #eee; border-radius: 10px; 
            border-left: 4px solid #ccc; overflow: hidden; 
        }
        .detail-card-item.best-card { background-color: #fafffc; }
        
        .detail-card-header { 
            padding: 8px 12px; background: #f9f9f9; 
            font-weight: 600; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; /* ç¸®å°å­—é«” */
        }
        .detail-card-body { padding: 10px 12px; font-size: 0.85rem; }
        .detail-note { color: #666; margin-top: 4px; display: block; line-height: 1.3; }

        .action-btn { width:100%; padding:14px; background:var(--color-primary); color:white; border:none; border-radius:12px; font-weight:700; margin-top:10px; font-size:1.1rem; box-shadow: 0 4px 10px rgba(33, 128, 160, 0.3); }
        .action-btn:active { transform: scale(0.98); }

    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’³ ä¿¡ç”¨å¡å›é¥‹æŸ¥è©¢ 2026</h1>

        <div class="nav-tabs">
            <div class="nav-item active" onclick="switchTab('search')">
                <span class="nav-icon">ğŸ”</span><span>é€šè·¯æœå°‹</span>
            </div>
            <div class="nav-item" onclick="switchTab('overview')">
                <span class="nav-icon">ğŸ“‹</span><span>æ¬Šç›Šç¸½è¦½</span>
            </div>
            <div class="nav-item" onclick="switchTab('calculator')">
                <span class="nav-icon">ğŸ’°</span><span>å›é¥‹è©¦ç®—</span>
            </div>
        </div>

        <div id="tab-search" class="tab-content active">
            <div class="form-section">
                <div class="info-text">
                    âœ¨ <strong>2026 æ–°æˆ¶åŠ ç¢¼</strong>ï¼šUnicard æœ€é«˜ 7.5%ã€UBear ç¶²è³¼ 10%ã€‚
                </div>
                
                <div class="form-group">
                    <div class="input-wrapper">
                        <input type="text" id="searchMerchant" placeholder="è¼¸å…¥å•†å®¶ (å¦‚ï¼šå…¨å®¶ã€é«˜éµ)..." autocomplete="off" inputmode="search">
                        <button id="clearSearchBtn" class="clear-btn" onclick="clearSearch('searchMerchant', 'clearSearchBtn', true)">âœ•</button>
                        <div id="suggestionDropdown" class="suggestion-dropdown"></div>
                    </div>
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <select id="searchUnicardScheme" onchange="debouncedReSearch()">
                            <option value="any" selected>Unicard: ä»»æ„é¸ (3.5%)</option>
                            <option value="simple">Unicard: ç°¡å–®é¸ (3.0%)</option>
                            <option value="up">Unicard: UPé¸ (4.5%)</option>
                        </select>
                    </div>
                    <div class="toggle-btn" id="searchNewUserBtn" onclick="toggleSearchNewUser()">
                        <input type="checkbox" id="searchNewUser" class="toggle-checkbox" readonly>
                        <span>æˆ‘æ˜¯æ–°æˆ¶</span>
                    </div>
                </div>
                
                <div class="category-tags" id="quickCategoryTags"></div>
            </div>

            <div id="merchantResults">
                <div id="merchantContainer"></div>
            </div>
        </div>

        <div id="tab-overview" class="tab-content">
            <div id="cardOverviewContainer"></div>
        </div>

        <div id="tab-calculator" class="tab-content">
            <div class="form-section">
                <div class="form-group">
                    <label>æ¶ˆè²»é‡‘é¡</label>
                    <div class="input-wrapper">
                        <input type="number" id="calcAmount" placeholder="è¼¸å…¥é‡‘é¡" inputmode="numeric">
                    </div>
                </div>
                <div class="form-group">
                    <label>æ¶ˆè²»é€šè·¯</label>
                    <div class="input-wrapper">
                        <input type="text" id="calcMerchant" placeholder="è¼¸å…¥é€šè·¯ (å¦‚ï¼šè¦çš®)">
                        <button id="clearCalcBtn" class="clear-btn" onclick="clearSearch('calcMerchant', 'clearCalcBtn', false)">âœ•</button>
                        <div id="calcSuggestionDropdown" class="suggestion-dropdown"></div>
                    </div>
                </div>
                <div class="controls-row">
                    <div class="control-group">
                        <select id="calcUnicardScheme">
                            <option value="any" selected>Unicard: ä»»æ„é¸</option>
                            <option value="simple">Unicard: ç°¡å–®é¸</option>
                            <option value="up">Unicard: UPé¸</option>
                        </select>
                    </div>
                    <div class="toggle-btn" id="calcNewUserBtn" onclick="toggleCalcNewUser()">
                        <input type="checkbox" id="calcNewUser" class="toggle-checkbox" readonly>
                        <span>æˆ‘æ˜¯æ–°æˆ¶</span>
                    </div>
                </div>
                <button onclick="calculateRewards()" class="action-btn">é–‹å§‹è©¦ç®—</button>
            </div>
            <div id="calcResults"></div>
        </div>

    </div>

    <div id="detailModal" class="detail-modal" onclick="if(event.target === this) closeDetailModal()">
        <div class="detail-content">
            <div class="detail-header">
                <div class="detail-title">
                    <h2 id="modalTitle">æ’åè©³æƒ…</h2>
                </div>
                <button class="detail-close" onclick="closeDetailModal()">âœ•</button>
            </div>
            <div id="detailBody" class="detail-body"></div>
        </div>
    </div>

    <script>
        const formatMoney = (num) => '$' + Math.floor(num).toLocaleString();
        const formatRate = (num) => (num * 100).toFixed(1).replace('.0', '') + '%';
        
        const debounce = (func, delay = 300) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func(...args), delay);
            };
        };

        const brandColorMap = {
            'richart': { class: 'card-theme-richart', color: '#e01a22' },
            'cube': { class: 'card-theme-cube', color: '#00AA4F' },
            'unicard': { class: 'card-theme-unicard', color: '#1890ff' },
            'ubear': { class: 'card-theme-ubear', color: '#e6b800' },
            'dawho': { class: 'card-theme-dawho', color: '#2d3436' }
        };

        const cardBenefitsData = [
            {
                id: 'richart', name: 'å°æ–° Richart', note: 'éœ€æ¯æ—¥ App åˆ‡æ›æ¬Šç›Š (ç„¡ä¸Šé™)',
                benefits: [
                    { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.003, desc: 'åœ‹å…§å¤–ä¸€èˆ¬æ¶ˆè²»', type: 'text', note: '0.3%', cap: Infinity },
                    { name: 'Payè‘—åˆ·', rate: 0.038, desc: 'ç¶å®šå°æ–°Pay', note: '3.8%', tag: 'pay', cap: Infinity, categories: { 'è¡Œå‹•æ”¯ä»˜':['7-11','å…¨å®¶','æ–°å…‰ä¸‰è¶Š','IKEA','NET','éº¥ç•¶å‹'] } },
                    { name: 'LINE Pay', rate: 0.023, desc: 'LINE Pay ç¶å®šæ”¯ä»˜', note: '2.3%', tag: 'line', cap: Infinity, categories: { 'æ”¯ä»˜':['LINE Pay'] } },
                    { name: 'å‡æ—¥åˆ·', rate: 0.02, desc: 'åœ‹å…§ç¯€å‡æ—¥æ¶ˆè²»', note: '2%', tag: 'holiday', type: 'text', categories: {}, cap: Infinity },
                    { name: 'æ•¸è¶£åˆ·', rate: 0.033, desc: 'ç¶²è³¼ | éŠæˆ² | AI', note: '3.3%', tag: 'digital', cap: Infinity, categories: { 'ç¶²è³¼':['è¦çš®','momo','PChome','æ·˜å¯¶','Amazon','Coupang','åšå®¢ä¾†'], 'å½±éŸ³':['Netflix','Disney+','Youtube','Spotify','ChatGPT'] } },
                    { name: 'ç©æ—…åˆ·', rate: 0.033, desc: 'æµ·å¤– | èˆªç©º | è¨‚æˆ¿', note: '3.3%', tag: 'travel', cap: Infinity, categories: { 'æ—…éŠ':['æµ·å¤–æ¶ˆè²»','æ—¥æœ¬','éŸ“åœ‹','Klook','Agoda','Booking','è¯èˆª','é•·æ¦®','æ˜Ÿå®‡','Uber'] } },
                    { name: 'å¤©å¤©åˆ·', rate: 0.033, desc: 'è¶…å•†é‡è²© | äº¤é€š', note: '3.3%', tag: 'daily', cap: Infinity, categories: { 'æ—¥å¸¸':['å…¨å®¶','7-11','å®¶æ¨‚ç¦','é«˜éµ','å°éµ','Uber','yoxi','å±ˆè‡£æ°','åº·æ˜¯ç¾','å¯¶é›…'] } },
                    { name: 'å¤§ç­†åˆ·', rate: 0.033, desc: 'ç™¾è²¨ | Outlet | å±…å®¶', note: '3.3%', tag: 'big', cap: Infinity, categories: { 'ç™¾è²¨':['æ–°å…‰ä¸‰è¶Š','é æ±SOGO','å·¨åŸ','æ¼¢ç¥','101','è¯æ³°åå“åŸ','ä¸‰äº•OUTLET','IKEA','ç‰¹åŠ›å±‹','UNIQLO','GU'] } },
                    { name: 'å¥½é¥—åˆ·', rate: 0.033, desc: 'é¤é£² | å¤–é€ | åŠ æ²¹', note: '3.3%', tag: 'fun', cap: Infinity, categories: { 'é¤é£²':['åœ‹å…§é¤é£²','Uber Eats','foodpanda','ä¸­æ²¹ç›´ç‡Ÿ','éŒ¢æ«ƒ','å¥½æ¨‚è¿ª'] } }
                ]
            },
            {
                id: 'cube', name: 'åœ‹æ³° CUBE', note: 'éœ€æ¯æ—¥ App åˆ‡æ›æ–¹æ¡ˆ (ç„¡ä¸Šé™)',
                benefits: [
                    { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.003, desc: 'ä¸€èˆ¬æ¶ˆè²» (ç„¡ä¸Šé™)', type: 'text', note: '0.3%', categories: {}, cap: Infinity },
                    { name: 'ç˜‹å¤§æ¸¯', rate: 0.035, desc: 'é«˜é›„ä½å®¿ | Klook | é«˜éµå°éµ', note: '3.5%', tag: 'crazy', categories: { 'æŒ‡å®š':['Klook','é«˜éµ','å°éµ'] }, cap: Infinity },
                    { name: 'ç©æ•¸ä½', rate: 0.03, desc: 'ç¶²è³¼ | å½±éŸ³ | AI', note: '3%', tag: 'digital', cap: Infinity, categories: { 'ç¶²è³¼':['è¦çš®','momo','PChome','æ·˜å¯¶','Coupang'], 'å½±éŸ³':['Netflix','Disney+','Spotify','Apple','Google Play'] } },
                    { name: 'æ¨‚éŸ¿è³¼', rate: 0.03, desc: 'ç™¾è²¨ | é¤é£² | å¤–é€ | è—¥å¦', note: '3%', tag: 'fun', cap: Infinity, categories: { 'ç”Ÿæ´»':['æ–°å…‰ä¸‰è¶Š','SOGO','é æ±ç™¾è²¨','101','åœ‹å…§é¤é£²','éº¥ç•¶å‹','Uber Eats','foodpanda','åº·æ˜¯ç¾','å±ˆè‡£æ°'] } },
                    { name: 'è¶£æ—…è¡Œ', rate: 0.03, desc: 'æµ·å¤– | è¨‚æˆ¿ | èˆªç©º | äº¤é€š', note: '3%', tag: 'travel', cap: Infinity, categories: { 'æ—…éŠ':['æµ·å¤–å¯¦é«”','æ—¥æœ¬','éŸ“åœ‹','Klook','Agoda','Booking','Airbnb','è¯èˆª','é•·æ¦®','æ˜Ÿå®‡','é«˜éµ','Uber','yoxi','ä¸­æ²¹ç›´ç‡Ÿ'] } },
                    { name: 'é›†ç²¾é¸', rate: 0.02, desc: 'è¶…å•† | é‡è²© | åŠ æ²¹ | IKEA', note: '2%', tag: 'base', cap: Infinity, categories: { 'ç²¾é¸':['7-11','å…¨å®¶','å…¨è¯','å®¶æ¨‚ç¦','ä¸­æ²¹ç›´ç‡Ÿ','IKEA'] } }
                ]
            },
            {
                id: 'unicard', name: 'ç‰å±± Unicard', note: 'ç•¶æœˆæœˆåº•æœ€å¾Œä¸€å¤©åˆ‡æ–¹æ¡ˆ',
                benefits: [
                    { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.01, desc: 'ä¸€èˆ¬æ¶ˆè²» (ç„¡ä¸Šé™)', type: 'text', note: '1%', categories: {}, cap: Infinity },
                    { 
                        name: 'ç™¾å¤§ç‰¹åº—', rate: 0, tag: 'list', type: 'modal',
                        desc: 'é»æ“ŠæŸ¥çœ‹å®Œæ•´åå–®', 
                        categories: {
                            'è¡Œå‹•æ”¯ä»˜': ['ç‰å±±Wallet', 'LINE Pay', 'å…¨æ”¯ä»˜', 'è¡—å£æ”¯ä»˜', 'æ‚ éŠä»˜', 'å…¨ç›ˆ+PAY', 'iPASS MONEY', 'icash Pay'],
                            'åŠ æ²¹äº¤é€š': ['å°ç£ä¸­æ²¹-ç›´ç‡Ÿç«™', '55688', 'å°ç£éµè·¯', 'å°ç£é«˜éµ', 'Uber', 'Yoxi'],
                            'åœ‹å…§ç™¾è²¨': ['æ–°å…‰ä¸‰è¶Š', 'é æ±ç™¾è²¨', 'æ¼¢ç¥ç™¾è²¨', 'å¾®é¢¨', 'å°åŒ—101', 'è¯æ³°åå“åŸ', 'ä¸‰äº•OUTLET', 'äº¬ç«™', 'ç¾éº—è¯', 'èª å“', 'ç§€æ³°', 'LaLaport', 'çµ±é ˜', 'çµ±ä¸€æ™‚ä»£', 'æ˜‡æ†æ˜Œ', 'é‡‡ç›Ÿ'],
                            'é¤é£²ç¾é£Ÿ': ['Uber Eats', 'foodpanda', 'EZTABLE', 'ç‹å“ç˜‹Pay', 'é¥—è³“', 'ç“¦åŸ', 'ä¹¾æ¯', 'æ¼¢ä¾†ç¾é£Ÿ', 'é¼ç‹', 'çˆ­é®®'],
                            'èˆªç©ºæ—…éŠ': ['ä¸­è¯èˆªç©º', 'é•·æ¦®èˆªç©º', 'æ—¥æœ¬èˆªç©º', 'å°ç£è™èˆª', 'æ¨‚æ¡ƒèˆªç©º', 'é…·èˆª', 'Trip.com', 'Booking.com', 'Hotels.com', 'AsiaYo', 'Expedia', 'KKday', 'Klook', 'é›„ç…', 'å¯æ¨‚', 'æ±å—', 'Agoda'],
                            'ç²¾é¸å•†å®¶': ['Appleç›´ç‡Ÿåº—', 'å°ç±³å°ç£', 'å…¨åœ‹é›»å­', 'ç‡¦å¤', 'è¿ªå¡å„‚'],
                            'ç”Ÿæ´»æ¡è²·': ['å®¶æ¨‚ç¦', 'å±ˆè‡£æ°', 'åº·æ˜¯ç¾', 'ç‰¹åŠ›å±‹', 'HOLA', 'hoi', 'UNIQLO', 'NET', 'å¤§æ¨¹è—¥å±€', 'ä¸ä¸è—¥å¦'],
                            'é›»å•†å¹³å°': ['momoè³¼ç‰©ç¶²', 'è¦çš®è³¼ç‰©', 'æ·˜å¯¶', 'Coupangé…·æ¾'],
                            'åœ‹å¤–å¯¦é«”': ['æ—¥æœ¬', 'éŸ“åœ‹', 'æ³°åœ‹', 'è¶Šå—', 'æ–°åŠ å¡', 'é¦¬ä¾†è¥¿äº', 'è²å¾‹è³“', 'ä¸­åœ‹', 'é¦™æ¸¯', 'æ¾³é–€', 'ç¾åœ‹', 'åŠ æ‹¿å¤§', 'è‹±åœ‹', 'æ³•åœ‹', 'å¾·åœ‹', 'ç¾©å¤§åˆ©', 'æ¾³æ´²'],
                            'ESGæ¶ˆè²»': ['ç‰¹æ–¯æ‹‰', 'Gogoro', 'YouBike']
                        },
                        note: 'å›é¥‹ä¾æ–¹æ¡ˆ',
                        cap: Infinity
                    },
                    { name: 'UPé¸', rate: 0.045, desc: 'ç™¾å¤§ç‰¹åº— (éœ€149é»è¨‚é–±)', type: 'text', note: 'ä¸€èˆ¬1% + UPé¸3.5% (ä¸Šé™åˆ·$142,857)', cap: 142857 },
                    { name: 'ä»»æ„é¸', rate: 0.035, desc: 'ç™¾å¤§ç‰¹åº— (éœ€è¨­å®š8å®¶)', type: 'text', note: 'ä¸€èˆ¬1% + ä»»æ„é¸2.5% (ä¸Šé™åˆ·$400,000)', cap: 400000 },
                    { name: 'ç°¡å–®é¸', rate: 0.03, desc: 'ç™¾å¤§ç‰¹åº—', note: 'ä¸€èˆ¬1% + ç°¡å–®é¸2% (ä¸Šé™åˆ·$500,000)', cap: 500000 },
                    { name: 'æ–°æˆ¶å›é¥‹', rate: 0.03, tag: 'new', note: 'æ–°æˆ¶+3% (ä¸Šé™åˆ·$14,667)', cap: 14667 }
                ]
            },
            {
                id: 'ubear', name: 'ç‰å±± UBear', note: 'å¨›æ¨‚10% / ç¶²è³¼3% (ç¶²è³¼ä¸Šé™åˆ· $7,500)',
                benefits: [
                    { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.01, desc: 'ä¸€èˆ¬æ¶ˆè²»', type: 'text', note: '1%', cap: Infinity, categories: {} },
                    { name: 'å½±éŸ³å¨›æ¨‚', rate: 0.10, desc: 'Netflix | Disney+ | Nintendo', note: '10% (ä¸Šé™åˆ·$1000)', tag: 'ent', cap: 1000, categories: { 'å½±éŸ³':['Netflix','Disney+','Nintendo','PlayStation','KKBOX','iTunes','Google Play'] } },
                    { name: 'ç¶²è³¼/Pay', rate: 0.03, desc: 'ç¶²è³¼ | è¡Œå‹•æ”¯ä»˜', note: 'ä¸€èˆ¬1% + ç¶²è³¼2% (ä¸Šé™åˆ·$7500)', tag: 'net', cap: 7500, categories: { 'ç¶²è³¼':['LINE Pay','è¡—å£','æ‚ éŠä»˜','OPENéŒ¢åŒ…','icash Pay','PChome','momo','è¦çš®','Coupang','æ·˜å¯¶','åšå®¢ä¾†','Uber','é«˜éµ','å°éµ','Uber Eats','foodpanda'] } },
                    { name: 'æ–°æˆ¶åŠ ç¢¼', rate: 0.07, tag: 'bonus', note: 'ç¶²è³¼/PayåŠ ç¢¼ + 7% (ä¸Šé™åˆ·$2142) æœ€é«˜10%', cap: 2142 }
                ]
            },
            {
                id: 'dawho', name: 'æ°¸è± DAWHO', note: 'å¤§æˆ¶ç­‰ç´šï¼šåœ‹å…§3.5%/åœ‹å¤–4.5% (ä¸Šé™åˆ· 1.6 è¬)',
                benefits: [
                    { name: 'ä¸€èˆ¬æ¶ˆè²»', rate: 0.01, desc: 'ä¸€èˆ¬æ¶ˆè²»', type: 'text', note: '1%', cap: Infinity, categories: {} },
                    { name: 'åœ‹å…§å…¨é€šè·¯', rate: 0.035, desc: 'åœ‹å…§åŠ ç¢¼', note: 'ä¸€èˆ¬1% + ä»»å‹™2.5% (ä¸Šé™åˆ·$16,000)', tag: 'all', cap: 16000, categories: { 'å…¨é€šè·¯':['åœ‹å…§æ¶ˆè²»'] } },
                    { name: 'åœ‹å¤–å…¨é€šè·¯', rate: 0.045, desc: 'åœ‹å¤–åŠ ç¢¼', note: 'ä¸€èˆ¬2% + ä»»å‹™2.5% (ä¸Šé™åˆ·$16,000)', tag: 'foreign', cap: 16000, categories: { 'å…¨é€šè·¯':['åœ‹å¤–æ¶ˆè²»','æ—¥æœ¬','éŸ“åœ‹'] } },
                    { name: 'æ‚ éŠå¡', rate: 0.03, desc: 'è‡ªå‹•åŠ å€¼', note: '3% (ä¸Šé™åˆ·$3333)', tag: 'easy', cap: 3333 }
                ]
            }
        ];

        const normalizationMap = { 'å…¨å®¶':'å…¨å®¶', '7-11':'7-11', 'è¦çš®':'è¦çš®', 'é«˜éµ':'é«˜éµ', 'å°éµ':'å°éµ', 'ä¸­æ²¹':'ä¸­æ²¹ç›´ç‡Ÿ', 'linepay':'LINE Pay', 'ubereats':'Uber Eats', 'momo':'momo' };
        const quickFilters = [
            { name: 'ğŸª è¶…å•†é‡è²©', kw: ['è¶…å•†','é‡è²©','å…¨è¯','å®¶æ¨‚ç¦'] },
            { name: 'ğŸ” é¤é£²å¤–é€', kw: ['é¤é£²','å¤–é€','éº¥ç•¶å‹'] },
            { name: 'ğŸ›ï¸ ç¶²è³¼å¹³å°', kw: ['ç¶²è³¼','é›»å•†','è¦çš®','momo'] },
            { name: 'ğŸš„ äº¤é€šæ—…éŠ', kw: ['äº¤é€š','æ—…éŠ','æ—¥æœ¬','é«˜éµ'] },
            { name: 'ğŸ’³ è¡Œå‹•æ”¯ä»˜', kw: ['æ”¯ä»˜','Pay'] }
        ];

        let globalMerchantDB = {};
        let activeFilter = null;

        function init() {
            generateDB(); renderQuickFilters(); renderOverview();
            
            const debouncedSearch = debounce((e) => {
                const val = e.target.value.trim().toLowerCase();
                document.getElementById('clearSearchBtn').style.display = val ? 'flex' : 'none';
                if (val) renderMerchantResult(val);
                else { 
                    if(activeFilter) applyFilter(activeFilter); 
                    else document.getElementById('merchantContainer').innerHTML = '';
                }
            }, 300);

            document.getElementById('searchMerchant').addEventListener('input', debouncedSearch);
            document.getElementById('calcMerchant').addEventListener('input', handleCalcSuggest);
        }

        function generateDB() {
            globalMerchantDB = {};
            cardBenefitsData.forEach(card => {
                card.benefits.forEach(b => {
                    if (card.id === 'unicard' && b.tag === 'new') return; // éš±è—ç¨ç«‹æ–°æˆ¶é …
                    if (b.categories) {
                        Object.entries(b.categories).forEach(([cat, list]) => {
                            list.forEach(m => {
                                const key = (normalizationMap[m.toLowerCase()] || m).toLowerCase();
                                if (!globalMerchantDB[key]) globalMerchantDB[key] = { name: m, category: cat, cards: [] };
                                if (!globalMerchantDB[key].cards.some(c => c.scheme === b.name)) {
                                    globalMerchantDB[key].cards.push({ cardId: card.id, cardName: card.name, rate: b.rate, scheme: b.name, note: b.note, tag: b.tag, cap: b.cap });
                                }
                            });
                        });
                    }
                });
            });
        }

        function renderQuickFilters() {
            document.getElementById('quickCategoryTags').innerHTML = quickFilters.map(f => `<div class="category-tag" onclick="applyFilter('${f.name}')">${f.name}</div>`).join('');
        }
        function applyFilter(name) {
            const tags = document.querySelectorAll('.category-tag');
            if (activeFilter === name) { 
                activeFilter = null; tags.forEach(t => t.classList.remove('active')); 
                document.getElementById('merchantContainer').innerHTML = ''; return; 
            }
            activeFilter = name; tags.forEach(t => t.classList.toggle('active', t.innerText === name));
            document.getElementById('searchMerchant').value = ''; // æ¸…ç©ºæœå°‹æ¡†
            
            const kw = quickFilters.find(f => f.name === name).kw;
            const matched = Object.values(globalMerchantDB).filter(d => kw.some(k => d.category.includes(k) || d.name.includes(k)));
            document.getElementById('merchantContainer').innerHTML = matched.map(d => generateCardHTML(d.name)).join('');
        }

        function toggleSearchNewUser() {
            const chk = document.getElementById('searchNewUser');
            chk.checked = !chk.checked;
            document.getElementById('searchNewUserBtn').classList.toggle('active', chk.checked);
            
            const val = document.getElementById('searchMerchant').value.trim();
            if (val) renderMerchantResult(val); else if (activeFilter) applyFilter(activeFilter);
        }

        const debouncedReSearch = debounce(() => {
             const val = document.getElementById('searchMerchant').value;
             if (val) renderMerchantResult(val);
        }, 300);

        function renderMerchantResult(name) { document.getElementById('merchantContainer').innerHTML = generateCardHTML(name); }

        function generateCardHTML(name) {
            const key = name.toLowerCase();
            let data = globalMerchantDB[key];
            // æ¨¡ç³Šæœå°‹
            if (!data) {
                const foundKey = Object.keys(globalMerchantDB).find(k => k.includes(key) || key.includes(k));
                if (foundKey) data = globalMerchantDB[foundKey];
            }

            let cards = [];
            if (data) {
                cards = JSON.parse(JSON.stringify(data.cards));
            } else {
                // æ‰¾ä¸åˆ°ç‰¹å®šé€šè·¯æ™‚çš„é è¨­å¡ç‰‡
                cards.push({ cardId: 'unicard', cardName: 'ç‰å±± Unicard', rate: 0.01, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '1%', cap:Infinity });
                cards.push({ cardId: 'ubear', cardName: 'ç‰å±± UBear', rate: 0.01, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '1%', cap:Infinity });
                cards.push({ cardId: 'richart', cardName: 'å°æ–° Richart', rate: 0.003, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '0.3%', cap:Infinity });
                cards.push({ cardId: 'cube', cardName: 'åœ‹æ³° CUBE', rate: 0.003, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '0.3%', cap:Infinity });
            }

            const isNew = document.getElementById('searchNewUser').checked;
            const uniScheme = document.getElementById('searchUnicardScheme').value;

            // è£œä¸Šé€šç”¨å¡ (å¦‚æœåˆ—è¡¨ä¸­æ²’æœ‰å¤§æˆ¶)
            if (!cards.find(c => c.cardId === 'dawho')) {
                const isF = ['åœ‹å¤–','æ—¥æœ¬','éŸ“åœ‹','æµ·å¤–'].some(k => name.includes(k));
                cards.push({ cardId: 'dawho', cardName: 'æ°¸è± DAWHO', rate: isF?0.045:0.035, scheme: isF?'åœ‹å¤–æ¶ˆè²»':'åœ‹å…§æ¶ˆè²»', note: isF?'ä¸€èˆ¬2% + ä»»å‹™2.5%':'ä¸€èˆ¬1% + ä»»å‹™2.5%', cap: 16000 });
            }

            cards.forEach(c => {
                // Unicard é‚è¼¯
                if (c.cardId === 'unicard' && c.tag === 'list') {
                    if (uniScheme === 'simple') { c.rate = 0.03; c.scheme = 'ç°¡å–®é¸'; c.cap = 500000; }
                    else if (uniScheme === 'up') { c.rate = 0.045; c.scheme = 'UPé¸'; c.cap = 142857; }
                    else { c.rate = 0.035; c.scheme = 'ä»»æ„é¸'; c.cap = 400000; }
                    
                    if (isNew && ['line pay','uber eats','å®¶æ¨‚ç¦','éŸ“åœ‹','å…¨ç›ˆ'].some(k => name.toLowerCase().includes(k))) {
                        c.rate += 0.03; c.scheme += ' + æ–°æˆ¶'; c.effectiveCap = 14667; 
                    }
                }
                // UBear é‚è¼¯
                if (c.cardId === 'ubear' && c.tag === 'net' && isNew) {
                    c.rate = 0.10; c.scheme = 'ç¶²è³¼/Pay + æ–°æˆ¶'; c.note = 'ç¶²è³¼/PayåŠ ç¢¼ + 7% (ä¸Šé™åˆ·$2142) æœ€é«˜10%'; c.effectiveCap = 2142;
                }
            });

            cards.sort((a,b) => b.rate - a.rate);
            const best = cards[0];
            const theme = brandColorMap[best.cardId]?.class || '';
            const color = brandColorMap[best.cardId]?.color || '#ccc';

            return `
                <div class="merchant-list ${theme}" onclick='openRankingModal(${JSON.stringify(cards)}, "${name}")'>
                    <div class="merchant-info">
                        <div class="merchant-name">${name}</div>
                        <span class="merchant-type">${data ? data.category : 'æœå°‹çµæœ'}</span>
                    </div>
                    <div class="merchant-best-info">
                        <div class="best-rate">${formatRate(best.rate)}</div>
                        <div class="best-card-row">
                            <span class="card-icon-shape" style="background:${color}"></span>
                            ${best.cardName} 
                            <span class="scheme-badge list-badge">${best.scheme}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateRewards() {
            const amount = parseFloat(document.getElementById('calcAmount').value);
            const merchant = document.getElementById('calcMerchant').value.trim();
            const isNewUser = document.getElementById('calcNewUser').checked;
            const unicardScheme = document.getElementById('calcUnicardScheme').value;
            const container = document.getElementById('calcResults');

            if (!amount || !merchant) return;

            // ä¿®æ­£ï¼šç›´æ¥æŸ¥è©¢ DBï¼Œä¸é€é DOM è§£æ
            const key = merchant.toLowerCase();
            let data = globalMerchantDB[key];
            if (!data) {
                // æ¨¡ç³Šæœå°‹
                const foundKey = Object.keys(globalMerchantDB).find(k => k.includes(key) || key.includes(k));
                if (foundKey) data = globalMerchantDB[foundKey];
            }

            let cards = [];
            if (data) {
                cards = JSON.parse(JSON.stringify(data.cards));
            } else {
                // é è¨­å¡ç‰‡
                cards.push({ cardId: 'unicard', cardName: 'ç‰å±± Unicard', rate: 0.01, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '1%', cap:Infinity });
                cards.push({ cardId: 'ubear', cardName: 'ç‰å±± UBear', rate: 0.01, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '1%', cap:Infinity });
                cards.push({ cardId: 'richart', cardName: 'å°æ–° Richart', rate: 0.003, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '0.3%', cap:Infinity });
                cards.push({ cardId: 'cube', cardName: 'åœ‹æ³° CUBE', rate: 0.003, scheme: 'ä¸€èˆ¬æ¶ˆè²»', note: '0.3%', cap:Infinity });
            }

            // è£œä¸Šå¤§æˆ¶
            if (!cards.find(c => c.cardId === 'dawho')) {
                const isF = ['åœ‹å¤–','æ—¥æœ¬','éŸ“åœ‹','æµ·å¤–'].some(k => merchant.includes(k));
                cards.push({ cardId: 'dawho', cardName: 'æ°¸è± DAWHO', rate: isF?0.045:0.035, scheme: isF?'åœ‹å¤–æ¶ˆè²»':'åœ‹å…§æ¶ˆè²»', note: isF?'ä¸€èˆ¬2% + ä»»å‹™2.5%':'ä¸€èˆ¬1% + ä»»å‹™2.5%', cap: 16000 });
            }

            const results = cards.map(c => {
                // å¥—ç”¨æ–¹æ¡ˆé‚è¼¯
                if (c.cardId === 'unicard' && c.tag === 'list') {
                    if (unicardScheme === 'simple') { c.rate = 0.03; c.scheme = 'ç°¡å–®é¸'; c.cap = 500000; }
                    else if (unicardScheme === 'up') { c.rate = 0.045; c.scheme = 'UPé¸'; c.cap = 142857; }
                    else { c.rate = 0.035; c.scheme = 'ä»»æ„é¸'; c.cap = 400000; }
                    
                    if (isNewUser && ['line pay','uber eats','å®¶æ¨‚ç¦','éŸ“åœ‹','å…¨ç›ˆ'].some(k => merchant.toLowerCase().includes(k))) {
                        c.rate += 0.03; c.scheme += ' + æ–°æˆ¶'; c.effectiveCap = 14667; 
                    }
                }
                if (c.cardId === 'ubear' && c.tag === 'net' && isNewUser) {
                    c.rate = 0.10; c.scheme = 'ç¶²è³¼/Pay + æ–°æˆ¶'; c.note = 'ç¶²è³¼/PayåŠ ç¢¼ + 7% (ä¸Šé™åˆ·$2142) æœ€é«˜10%'; c.effectiveCap = 2142;
                }

                let reward = 0, detail = '', cap = c.effectiveCap || c.cap || Infinity;
                
                // Richart ä¿®æ­£ï¼šç„¡ä¸Šé™ï¼Œç›´æ¥ç®—
                if (c.cardId === 'richart') {
                    reward = Math.floor(amount * c.rate);
                    detail = `${formatMoney(reward)} (${formatRate(c.rate)})`;
                }
                // åœ‹æ³° CUBE ä¿®æ­£ï¼šç„¡ä¸Šé™
                else if (c.cardId === 'cube') {
                    reward = Math.floor(amount * c.rate);
                    detail = `${formatMoney(reward)} (æ–¹æ¡ˆ${formatRate(c.rate)})`;
                }
                // å…¶ä»–æœ‰ä¸Šé™çš„å¡ç‰‡
                else {
                    if (amount <= cap) { 
                        reward = Math.floor(amount * c.rate); 
                        detail = `${formatMoney(reward)} (${formatRate(c.rate)})`;
                    } else {
                        reward = Math.floor(cap * c.rate) + Math.floor((amount - cap) * 0.01);
                        detail = `${formatMoney(Math.floor(cap * c.rate))} (ä¸Šé™å…§) + ${formatMoney(Math.floor((amount-cap)*0.01))} (1%)`;
                    }
                }
                return { ...c, reward, detail, currentCap: cap };
            }).sort((a,b) => b.reward - a.reward);

            const winner = results[0];
            const backup = results.filter(r => r.cardId !== winner.cardId).sort((a,b) => b.rate - a.rate)[0];
            let splitHtml = '';
            
            // æ‹†å–®å»ºè­°
            if (winner.currentCap < amount && winner.currentCap !== Infinity && backup && backup.rate > 0.01) {
                const winnerMaxReward = Math.floor(winner.currentCap * winner.rate);
                const remaining = amount - winner.currentCap;
                const backupReward = Math.floor(remaining * backup.rate);
                const splitTotal = winnerMaxReward + backupReward;
                
                if (splitTotal > winner.reward + 10) { 
                    splitHtml = `
                        <div class="split-box">
                            <div class="split-title">ğŸ’¡ å»ºè­°æ‹†å–® (å¤šè³º ${formatMoney(splitTotal - winner.reward)})</div>
                            <div class="split-step">å…ˆåˆ· <b>${winner.cardName}</b>ï¼š${formatMoney(winner.currentCap)}</div>
                            <div class="split-step">é¤˜é¡ <b>${backup.cardName}</b>ï¼š${formatMoney(remaining)}</div>
                            <div style="font-weight:700; margin-top:6px; padding-top:4px; border-top:1px dotted #ccc">é æœŸç¸½å›é¥‹ï¼š${formatMoney(splitTotal)}</div>
                        </div>
                    `;
                }
            }

            document.getElementById('calcResults').innerHTML = results.map((res, idx) => `
                <div class="calc-result-item ${idx===0?'winner ':''}${brandColorMap[res.cardId].class}">
                    <div class="calc-header">
                        <span class="calc-title">${idx+1}. ${res.cardName} <span class="scheme-badge">${res.scheme}</span></span>
                        <span class="calc-money">${idx===0?'ğŸ†':''}${formatMoney(res.reward)}</span>
                    </div>
                    <div style="font-size:0.85em; color:${idx===0?'var(--color-success)':'#555'}; margin-bottom:4px">
                        ${res.detail.includes('(') ? 'å¹³å‡å›é¥‹ç‡ï¼š' + (res.reward/amount*100).toFixed(1)+'%' : ''}
                    </div>
                    <div class="calc-detail">${res.detail}</div>
                    ${idx===0 ? splitHtml : ''}
                </div>
            `).join('');
        }

        function openRankingModal(cards, name) {
            document.getElementById('modalTitle').innerText = `${name} å›é¥‹æ’å`;
            document.getElementById('detailBody').innerHTML = cards.map((c, i) => `
                <div class="detail-card-item ${brandColorMap[c.cardId].class} ${i===0?'best-card':''}">
                    <div class="detail-card-header">
                        <span>${i===0?'ğŸ† ':''}${c.cardName}</span>
                        <span>${formatRate(c.rate)}</span>
                    </div>
                    <div class="detail-card-body">
                        <span class="scheme-badge ${c.scheme.includes('æ–°æˆ¶')?'new-user':''}">${c.scheme}</span>
                        <div class="detail-note">${c.note}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('detailModal').classList.add('show');
        }

        function handleCalcSuggest(e) {
            const val = e.target.value.trim().toLowerCase();
            const drop = document.getElementById('calcSuggestionDropdown');
            if(!val) { drop.style.display='none'; return; }
            const matches = Object.keys(globalMerchantDB).filter(k => k.includes(val)).slice(0, 5);
            drop.innerHTML = matches.map(m => `<div class="suggestion-item" onclick="pickCalc('${globalMerchantDB[m].name}')">${globalMerchantDB[m].name}</div>`).join('');
            drop.style.display = matches.length ? 'block' : 'none';
        }
        function pickCalc(n) { document.getElementById('calcMerchant').value = n; document.getElementById('calcSuggestionDropdown').style.display='none'; calculateRewards(); }

        function renderOverview() {
            document.getElementById('cardOverviewContainer').innerHTML = cardBenefitsData.map(card => `
                <div class="card-accordion-item ${brandColorMap[card.id].class}">
                    <div class="accordion-header" onclick="this.nextElementSibling.classList.toggle('open')">
                        <span class="card-title-text"><span class="card-icon-shape" style="background:${brandColorMap[card.id].color}"></span> ${card.name}</span>
                        <span class="chevron">â–¼</span>
                    </div>
                    <div class="accordion-body">
                        <div class="benefit-row" style="background:#fff8e1; font-size:0.8em">ğŸ’¡ ${card.note}</div>
                        ${card.benefits.map(b => `<div class="benefit-row">
                            <div class="benefit-header"><span class="benefit-name">${b.name}</span><span class="benefit-rate">${b.rate?formatRate(b.rate):''}</span></div>
                            <div class="benefit-desc">${b.desc}</div>
                            ${b.note ? `<div class="benefit-note">ç´°ç¯€ï¼š${b.note}</div>` : ''}
                        </div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function switchTab(id) {
            document.querySelectorAll('.nav-item, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`[onclick*="${id}"]`).classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
        }
        function clearSearch(i, b, s) { document.getElementById(i).value=''; document.getElementById(b).style.display='none'; if(s) { document.getElementById('merchantContainer').innerHTML=''; activeFilter=null; document.querySelectorAll('.category-tag').forEach(t=>t.classList.remove('active')); } }
        function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
